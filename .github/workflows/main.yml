name: Build PULP RISC-V Toolchain (host armhf + aarch64, target X-HEEP rv32)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 * *'

permissions:
  contents: write

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - host_triplet: arm-linux-gnueabihf
            arch_label: armhf
            foreign_arch: armhf
            gcc_pkg: gcc-arm-linux-gnueabihf
            gxx_pkg: g++-arm-linux-gnueabihf
            binutils_pkg: binutils-arm-linux-gnueabihf
            qemu_binfmt: qemu-arm
            file_grep: "ARM"

          - host_triplet: aarch64-linux-gnu
            arch_label: aarch64
            foreign_arch: arm64
            gcc_pkg: gcc-aarch64-linux-gnu
            gxx_pkg: g++-aarch64-linux-gnu
            binutils_pkg: binutils-aarch64-linux-gnu
            qemu_binfmt: qemu-aarch64
            file_grep: "aarch64|ARM aarch64"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base dependencies (build tools + qemu + cross compiler)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y \
            autoconf automake autotools-dev curl \
            gawk build-essential bison flex texinfo gperf libtool patchutils bc \
            zlib1g-dev libexpat-dev \
            git ca-certificates \
            qemu-user-static binfmt-support \
            "${{ matrix.gcc_pkg }}" "${{ matrix.gxx_pkg }}" "${{ matrix.binutils_pkg }}" \
            libgmp-dev libmpfr-dev libmpc-dev

      - name: Enable multiarch + add Ubuntu Ports (jammy) for foreign arch
        shell: bash
        run: |
          set -euo pipefail

          sudo dpkg --add-architecture "${{ matrix.foreign_arch }}"

          # Add ports.ubuntu.com entries for the foreign architecture only.
          # Without this, apt will try archive/security.ubuntu.com which do not serve armhf/arm64 on amd64 runners.
          LIST="/etc/apt/sources.list.d/ubuntu-ports-${{ matrix.foreign_arch }}.list"
          sudo tee "${LIST}" >/dev/null <<EOF
          deb [arch=${{ matrix.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
          deb [arch=${{ matrix.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
          deb [arch=${{ matrix.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse
          deb [arch=${{ matrix.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy-backports main restricted universe multiverse
          EOF

          sudo apt-get update -y --allow-releaseinfo-change

      - name: Install host (foreign-arch) dev libs needed by GCC/binutils
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get install -y \
            "libgmp-dev:${{ matrix.foreign_arch }}" \
            "libmpfr-dev:${{ matrix.foreign_arch }}" \
            "libmpc-dev:${{ matrix.foreign_arch }}" \
            "zlib1g-dev:${{ matrix.foreign_arch }}" \
            "libexpat1-dev:${{ matrix.foreign_arch }}"

      - name: Enable binfmt for ${{ matrix.qemu_binfmt }}
        shell: bash
        run: |
          set -euo pipefail
          sudo update-binfmts --enable "${{ matrix.qemu_binfmt }}" || true
          sudo update-binfmts --display "${{ matrix.qemu_binfmt }}" || true

      - name: Verify QEMU binfmt works (sanity check)
        shell: bash
        run: |
          set -euo pipefail
          cat > hello.c <<'EOF'
          #include <stdio.h>
          int main(void){
          #if defined(__aarch64__)
            puts("hello-aarch64");
          #else
            puts("hello-armhf");
          #endif
            return 0;
          }
          EOF

          if [[ "${{ matrix.arch_label }}" == "armhf" ]]; then
            arm-linux-gnueabihf-gcc hello.c -o hello_host
            file hello_host
            ./hello_host | grep -q "hello-armhf"
          else
            aarch64-linux-gnu-gcc hello.c -o hello_host
            file hello_host
            ./hello_host | grep -q "hello-aarch64"
          fi

      - name: Clone RISC-V PULP Toolchain
        shell: bash
        run: |
          set -euo pipefail
          rm -rf pulp-riscv-gnu-toolchain
          git clone --recursive https://github.com/pulp-platform/pulp-riscv-gnu-toolchain.git

      - name: Configure + Build (host=${{ matrix.host_triplet }}, target=X-HEEP rv32imc)
        shell: bash
        run: |
          set -euo pipefail
          cd pulp-riscv-gnu-toolchain

          export CC="${{ matrix.host_triplet }}-gcc"
          export CXX="${{ matrix.host_triplet }}-g++"
          export AR="${{ matrix.host_triplet }}-ar"
          export RANLIB="${{ matrix.host_triplet }}-ranlib"
          export CC_FOR_BUILD=gcc
          export CXX_FOR_BUILD=g++

          PREFIX="/opt/pulp-riscv-${{ matrix.arch_label }}"

          ./configure \
            --prefix="${PREFIX}" \
            --host="${{ matrix.host_triplet }}" \
            --build="x86_64-linux-gnu" \
            --with-arch=rv32imc \
            --with-abi=ilp32

          # Force sub-configures to inherit the right host/build (prevents "cannot run C compiled programs")
          sudo -E make -j"$(nproc)" HOST="${{ matrix.host_triplet }}" BUILD="x86_64-linux-gnu"

      - name: Verify toolchain host binary architecture
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/pulp-riscv-${{ matrix.arch_label }}"
          BIN="${PREFIX}/bin/riscv32-unknown-elf-gcc"
          test -x "$BIN" || { echo "ERROR: gcc not found at $BIN"; exit 1; }
          file "$BIN"
          file "$BIN" | grep -Eqi "${{ matrix.file_grep }}" || { echo "ERROR: host arch mismatch"; exit 1; }

      - name: Verify toolchain produces RISC-V 32-bit ELF
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/pulp-riscv-${{ matrix.arch_label }}"
          export PATH="${PREFIX}/bin:${PATH}"

          cat > rvtest.c <<'EOF'
          int add(int a,int b){ return a+b; }
          int main(void){ return add(1,2); }
          EOF

          riscv32-unknown-elf-gcc -march=rv32imc -mabi=ilp32 -nostdlib -Wl,--no-relax -o rvtest.elf rvtest.c
          file rvtest.elf
          file rvtest.elf | grep -qi "ELF 32-bit" || { echo "ERROR: not 32-bit ELF"; exit 1; }
          readelf -h rvtest.elf | grep -qi "Machine: RISC-V" || { echo "ERROR: not RISC-V"; exit 1; }

      - name: Create TAR Archive
        shell: bash
        run: |
          set -euo pipefail
          OUT="pulp-toolchain-host-${{ matrix.arch_label }}-xheep-rv32imc.tar.gz"
          sudo tar -czvf "$OUT" -C /opt "pulp-riscv-${{ matrix.arch_label }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pulp-toolchain-host-${{ matrix.arch_label }}-xheep-rv32imc
          path: pulp-toolchain-host-${{ matrix.arch_label }}-xheep-rv32imc.tar.gz

      - name: Dump config.log on failure
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          find pulp-riscv-gnu-toolchain -name config.log -maxdepth 7 -print -exec tail -n 200 {} \; || true

  publish-rolling-release:
    needs: build-toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect tarballs
        shell: bash
        run: |
          set -euo pipefail
          find dist -type f -name "*.tar.gz" -print -exec cp -f {} . \;
          ls -la *.tar.gz

      - name: Publish rolling GitHub Release (latest)
        shell: bash
        run: |
          set -euo pipefail
          gh release delete latest --yes --cleanup-tag 2>/dev/null || true
          gh release create latest \
            pulp-toolchain-host-armhf-xheep-rv32imc.tar.gz \
            pulp-toolchain-host-aarch64-xheep-rv32imc.tar.gz \
            --title "Latest PULP RISC-V Toolchain (ARM hosts, X-HEEP rv32)" \
            --notes "Toolchains: host=armhf + aarch64, target=X-HEEP RISC-V 32-bit (rv32imc/ilp32). Run ${{ github.run_number }}, $(date -u +'%Y-%m-%d %H:%M UTC')."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
