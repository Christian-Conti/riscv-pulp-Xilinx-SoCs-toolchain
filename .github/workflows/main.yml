name: Build PULP RISC-V Toolchain (host armhf + aarch64, target X-HEEP rv32)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 * *'

permissions:
  contents: write

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - host_triplet: arm-linux-gnueabihf
            arch_label: armhf
            gcc_pkg: gcc-arm-linux-gnueabihf
            gxx_pkg: g++-arm-linux-gnueabihf
            binutils_pkg: binutils-arm-linux-gnueabihf
            qemu_binfmt: qemu-arm
            file_grep: "ARM"
          - host_triplet: aarch64-linux-gnu
            arch_label: aarch64
            gcc_pkg: gcc-aarch64-linux-gnu
            gxx_pkg: g++-aarch64-linux-gnu
            binutils_pkg: binutils-aarch64-linux-gnu
            qemu_binfmt: qemu-aarch64
            file_grep: "aarch64|ARM aarch64"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies (build tools + cross + qemu)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake autotools-dev curl \
            libmpc-dev libmpfr-dev libgmp-dev gawk build-essential \
            bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev \
            git ca-certificates \
            qemu-user-static binfmt-support \
            "${{ matrix.gcc_pkg }}" "${{ matrix.gxx_pkg }}" "${{ matrix.binutils_pkg }}"

      - name: Enable binfmt for ${{ matrix.qemu_binfmt }}
        shell: bash
        run: |
          set -euo pipefail
          sudo update-binfmts --enable "${{ matrix.qemu_binfmt }}" || true
          sudo update-binfmts --display "${{ matrix.qemu_binfmt }}" || true

      - name: Clone RISC-V PULP Toolchain
        shell: bash
        run: |
          set -euo pipefail
          rm -rf pulp-riscv-gnu-toolchain
          git clone --recursive https://github.com/pulp-platform/pulp-riscv-gnu-toolchain.git

      - name: Build Toolchain (host=${{ matrix.host_triplet }}, target=riscv32 X-HEEP rv32imc)
        shell: bash
        run: |
          set -euo pipefail
          cd pulp-riscv-gnu-toolchain

          # Host binaries (will run on the board: armhf or aarch64)
          export CC="${{ matrix.host_triplet }}-gcc"
          export CXX="${{ matrix.host_triplet }}-g++"
          export AR="${{ matrix.host_triplet }}-ar"
          export RANLIB="${{ matrix.host_triplet }}-ranlib"

          # Build-time tools (must run on the x86_64 runner)
          export CC_FOR_BUILD=gcc
          export CXX_FOR_BUILD=g++

          PREFIX="/opt/pulp-riscv-${{ matrix.arch_label }}"

          ./configure \
            --prefix="${PREFIX}" \
            --host="${{ matrix.host_triplet }}" \
            --build=x86_64-linux-gnu \
            --with-arch=rv32imc \
            --with-abi=ilp32

          sudo -E make -j"$(nproc)"

      - name: Verify toolchain binary architecture (must match host)
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/pulp-riscv-${{ matrix.arch_label }}"
          BIN="${PREFIX}/bin/riscv32-unknown-elf-gcc"
          test -x "$BIN" || { echo "ERROR: gcc not found at $BIN"; exit 1; }
          file "$BIN"
          file "$BIN" | grep -Eqi "${{ matrix.file_grep }}" || { echo "ERROR: host arch mismatch"; exit 1; }

      - name: Create TAR Archive
        shell: bash
        run: |
          set -euo pipefail
          OUT="pulp-toolchain-host-${{ matrix.arch_label }}-xheep-rv32imc.tar.gz"
          sudo tar -czvf "$OUT" -C /opt "pulp-riscv-${{ matrix.arch_label }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pulp-toolchain-host-${{ matrix.arch_label }}-xheep-rv32imc
          path: pulp-toolchain-host-${{ matrix.arch_label }}-xheep-rv32imc.tar.gz

  publish-rolling-release:
    needs: build-toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect tarballs
        shell: bash
        run: |
          set -euo pipefail
          find dist -type f -name "*.tar.gz" -print -exec cp -f {} . \;
          ls -la *.tar.gz

      - name: Publish rolling GitHub Release (latest)
        shell: bash
        run: |
          set -euo pipefail
          gh release delete latest --yes --cleanup-tag 2>/dev/null || true
          gh release create latest \
            pulp-toolchain-host-armhf-xheep-rv32imc.tar.gz \
            pulp-toolchain-host-aarch64-xheep-rv32imc.tar.gz \
            --title "Latest PULP RISC-V Toolchain (ARM hosts, X-HEEP rv32)" \
            --notes "Toolchains for ARM boards (armhf + aarch64). Target: X-HEEP RISC-V 32-bit (rv32imc/ilp32). Run ${{ github.run_number }}, $(date -u +'%Y-%m-%d %H:%M UTC')."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
