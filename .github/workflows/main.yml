name: Build RISC-V Toolchain for PYNQ (ARM host)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 * *'

permissions:
  contents: write

jobs:
  build-toolchain-host-armhf:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (build + armhf cross + qemu)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake autotools-dev curl \
            libmpc-dev libmpfr-dev libgmp-dev gawk build-essential \
            bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev \
            git ca-certificates \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            qemu-user-static binfmt-support

      - name: Enable binfmt qemu-arm
        shell: bash
        run: |
          set -euo pipefail
          sudo update-binfmts --enable qemu-arm || true
          sudo update-binfmts --display qemu-arm || true

      - name: Clone pulp toolchain
        shell: bash
        run: |
          set -euo pipefail
          rm -rf pulp-riscv-gnu-toolchain
          git clone --recursive https://github.com/pulp-platform/pulp-riscv-gnu-toolchain.git

      - name: Build (host=armhf, target=riscv32 rv32imc)
        shell: bash
        run: |
          set -euo pipefail
          cd pulp-riscv-gnu-toolchain

          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export AR=arm-linux-gnueabihf-ar
          export RANLIB=arm-linux-gnueabihf-ranlib

          export CC_FOR_BUILD=gcc
          export CXX_FOR_BUILD=g++

          ./configure \
            --prefix=/opt/pulp-riscv \
            --host=arm-linux-gnueabihf \
            --build=x86_64-linux-gnu \
            --with-arch=rv32imc \
            --with-abi=ilp32

          sudo -E make -j"$(nproc)"

      - name: Verify tool runs on ARM (binary is ARM)
        shell: bash
        run: |
          set -euo pipefail
          BIN=/opt/pulp-riscv/bin/riscv32-unknown-elf-gcc
          test -x "$BIN"
          file "$BIN"
          file "$BIN" | grep -q "ARM" || { echo "Not ARM"; exit 1; }

      - name: Pack
        shell: bash
        run: |
          set -euo pipefail
          tar -czf pulp-toolchain-host-armhf.tar.gz -C /opt pulp-riscv

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pulp-toolchain-host-armhf
          path: pulp-toolchain-host-armhf.tar.gz
