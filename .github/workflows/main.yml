name: Build RISC-V Toolchain

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 1 * *"

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  GIT_TERMINAL_PROMPT: "0"
  CCACHE_COMPRESS: "1"
  CCACHE_COMPRESSLEVEL: "6"

jobs:
  build-toolchain:
    name: ðŸ—ï¸ build (${{ matrix.host.arch_label }} / ${{ matrix.flavor.name }} / ${{ matrix.flavor.arch }}-${{ matrix.flavor.abi }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        host:
          - host_triplet: arm-linux-gnueabihf
            arch_label: armhf
            foreign_arch: armhf
            gcc_pkg: gcc-arm-linux-gnueabihf
            gxx_pkg: g++-arm-linux-gnueabihf
            binutils_pkg: binutils-arm-linux-gnueabihf
            qemu_binfmt: qemu-arm
            file_grep: "ARM"

          - host_triplet: aarch64-linux-gnu
            arch_label: aarch64
            foreign_arch: arm64
            gcc_pkg: gcc-aarch64-linux-gnu
            gxx_pkg: g++-aarch64-linux-gnu
            binutils_pkg: binutils-aarch64-linux-gnu
            qemu_binfmt: qemu-aarch64
            file_grep: "aarch64|ARM aarch64"

        flavor:
          - name: rv32e
            arch: rv32emac
            abi: ilp32e
            multilibs: "rv32e-ilp32e--c rv32ea-ilp32e--m rv32em-ilp32e--c rv32eac-ilp32e-- rv32emac-ilp32e--"

          - name: rv32i-imac
            arch: rv32imac
            abi: ilp32
            multilibs: "rv32i-ilp32--c rv32ia-ilp32--m rv32im-ilp32--c rv32iac-ilp32-- rv32imac-ilp32--"

          - name: rv32-float
            arch: rv32imafdc
            abi: ilp32d
            multilibs: "rv32if-ilp32f-rv32ifd-c rv32iaf-ilp32f-rv32imaf,rv32iafc-d rv32imf-ilp32f-rv32imfd-c rv32imafc-ilp32f-rv32imafdc- rv32ifd-ilp32d--c rv32imfd-ilp32d--c rv32iafd-ilp32d-rv32imafd,rv32iafdc- rv32imafdc-ilp32d--"

          - name: rv64i-imac
            arch: rv64imac
            abi: lp64
            multilibs: "rv64i-lp64--c rv64ia-lp64--m rv64im-lp64--c rv64iac-lp64-- rv64imac-lp64--"

          - name: rv64-float
            arch: rv64imafdc
            abi: lp64d
            multilibs: "rv64if-lp64f-rv64ifd-c rv64iaf-lp64f-rv64imaf,rv64iafc-d rv64imf-lp64f-rv64imfd-c rv64imafc-lp64f-rv64imafdc- rv64ifd-lp64d--m,c rv64iafd-lp64d-rv64imafd,rv64iafdc- rv64imafdc-lp64d--"

          # NOTE: xcvhwlp removed to avoid CORE-V GCC ICE in libbacktrace (no user flag exists to disable hwloop)
          - name: xheep-base
            arch: rv32imc_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip
            abi: ilp32
            multilibs: "rv32im_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32-- rv32imc_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32--"

          - name: xheep-float
            arch: rv32imfc_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip
            abi: ilp32f
            multilibs: "rv32imf_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32f-- rv32imfc_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32f--"

          - name: xheep-zfinx
            arch: rv32imc_zfinx_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip
            abi: ilp32
            multilibs: "rv32im_zfinx_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32-- rv32imc_zfinx_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32--"

    steps:
      - name: ðŸ§¾ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ·ï¸ Set build metadata
        shell: bash
        run: |
          set -euo pipefail
          echo "CI_DATE=$(date -u +%Y%m%d)" >> "$GITHUB_ENV"
          echo "PKGVERSION=corev-openhw-gcc-ci-$(date -u +%Y%m%d)" >> "$GITHUB_ENV"

      - name: âš¡ Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}
          max-size: 4G

      - name: ðŸ“¦ Install base dependencies
        shell: bash
        env:
          GCC_PKG: ${{ matrix.host.gcc_pkg }}
          GXX_PKG: ${{ matrix.host.gxx_pkg }}
          BINUTILS_PKG: ${{ matrix.host.binutils_pkg }}
        run: bash scripts/setup-deps.sh

      - name: ðŸ§© Configure APT sources for multiarch
        shell: bash
        env:
          FOREIGN_ARCH: ${{ matrix.host.foreign_arch }}
        run: bash scripts/setup-apt-multiarch.sh

      - name: ðŸ§± Install host (foreign-arch) dev libs
        shell: bash
        env:
          FOREIGN_ARCH: ${{ matrix.host.foreign_arch }}
        run: bash scripts/install-host-libs.sh

      - name: ðŸ¤– Enable binfmt for QEMU + smoke test
        shell: bash
        env:
          QEMU_BINFMT: ${{ matrix.host.qemu_binfmt }}
          FOREIGN_ARCH: ${{ matrix.host.foreign_arch }}
          HOST_TRIPLET: ${{ matrix.host.host_triplet }}
        run: bash scripts/setup-binfmt.sh

      - name: ðŸŒ Fetch sources (+ gdb)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/fetch-sources.sh

      - name: ðŸ—‚ï¸ Prepare /opt prefix
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"
          sudo mkdir -p "${PREFIX}"
          sudo chown -R "$USER:$USER" "${PREFIX}"

      - name: ðŸ› ï¸ Configure + Build (newlib + gdb)
        shell: bash
        env:
          PREFIX: /opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}
          HOST_TRIPLET: ${{ matrix.host.host_triplet }}
          ARCH: ${{ matrix.flavor.arch }}
          ABI: ${{ matrix.flavor.abi }}
          MULTILIBS: ${{ matrix.flavor.multilibs }}
        run: bash scripts/build-toolchain.sh

      - name: ðŸ”Ž Verify toolchain host binary architecture
        shell: bash
        env:
          PREFIX: /opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}
          FILE_GREP: ${{ matrix.host.file_grep }}
        run: bash scripts/verify-arch.sh

      - name: âœ… Verify toolchain produces RISC-V ELF
        shell: bash
        env:
          PREFIX: /opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}
          ARCH: ${{ matrix.flavor.arch }}
          ABI: ${{ matrix.flavor.abi }}
        run: bash scripts/verify-riscv.sh

      - name: ðŸ“¦ Create TAR Archive
        shell: bash
        run: |
          set -euo pipefail
          OUT="riscv-toolchain-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}-${CI_DATE}.tar.gz"
          tar -C /opt -czf "$OUT" "riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"

      - name: â˜ï¸ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: riscv-toolchain-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}-${{ env.CI_DATE }}
          path: riscv-toolchain-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}-${{ env.CI_DATE }}.tar.gz
          compression-level: 6

  publish-rolling-release:
    name: ðŸš€ publish (latest)
    needs: build-toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ§¾ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ·ï¸ Set build metadata
        shell: bash
        run: |
          set -euo pipefail
          echo "CI_DATE=$(date -u +%Y%m%d)" >> "$GITHUB_ENV"
          echo "PKGVERSION=corev-openhw-gcc-ci-$(date -u +%Y%m%d)" >> "$GITHUB_ENV"

      - name: â¬‡ï¸ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: ðŸ§º Collect tarballs
        shell: bash
        run: |
          set -euo pipefail
          find dist -type f -name "*.tar.gz" -print -exec cp -f {} . \;
          ls -la *.tar.gz

      - name: ðŸ·ï¸ Publish rolling GitHub Release (latest)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh release delete latest --yes --cleanup-tag 2>/dev/null || true
          gh release create latest \
            *.tar.gz \
            --title "Latest RISC-V Toolchain (Split Flavors)" \
            --notes "Toolchains built via GitHub Actions. Build date ${CI_DATE} (UTC)."
