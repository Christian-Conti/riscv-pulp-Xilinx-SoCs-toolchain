name: Build RISC-V Toolchain

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 * *'

permissions:
  contents: write

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        host:
          - host_triplet: arm-linux-gnueabihf
            arch_label: armhf
            foreign_arch: armhf
            gcc_pkg: gcc-arm-linux-gnueabihf
            gxx_pkg: g++-arm-linux-gnueabihf
            binutils_pkg: binutils-arm-linux-gnueabihf
            qemu_binfmt: qemu-arm
            file_grep: "ARM"

          - host_triplet: aarch64-linux-gnu
            arch_label: aarch64
            foreign_arch: arm64
            gcc_pkg: gcc-aarch64-linux-gnu
            gxx_pkg: g++-aarch64-linux-gnu
            binutils_pkg: binutils-aarch64-linux-gnu
            qemu_binfmt: qemu-aarch64
            file_grep: "aarch64|ARM aarch64"

        flavor:
          # --- RV32 STANDARD SPLIT ---
          - name: rv32e
            arch: rv32emac
            abi: ilp32e
            multilibs: "rv32e-ilp32e--c rv32ea-ilp32e--m rv32em-ilp32e--c rv32eac-ilp32e-- rv32emac-ilp32e--"
            
          - name: rv32i-imac
            arch: rv32imac
            abi: ilp32
            multilibs: "rv32i-ilp32--c rv32ia-ilp32--m rv32im-ilp32--c rv32iac-ilp32-- rv32imac-ilp32--"
            
          - name: rv32-float
            arch: rv32imafdc
            abi: ilp32d
            multilibs: "rv32if-ilp32f-rv32ifd-c rv32iaf-ilp32f-rv32imaf,rv32iafc-d rv32imf-ilp32f-rv32imfd-c rv32imafc-ilp32f-rv32imafdc- rv32ifd-ilp32d--c rv32imfd-ilp32d--c rv32iafd-ilp32d-rv32imafd,rv32iafdc- rv32imafdc-ilp32d--"

          # --- RV64 STANDARD SPLIT ---
          - name: rv64i-imac
            arch: rv64imac
            abi: lp64
            multilibs: "rv64i-lp64--c rv64ia-lp64--m rv64im-lp64--c rv64iac-lp64-- rv64imac-lp64--"
            
          - name: rv64-float
            arch: rv64imafdc
            abi: lp64d
            multilibs: "rv64if-lp64f-rv64ifd-c rv64iaf-lp64f-rv64imaf,rv64iafc-d rv64imf-lp64f-rv64imfd-c rv64imafc-lp64f-rv64imafdc- rv64ifd-lp64d--m,c rv64iafd-lp64d-rv64imafd,rv64iafdc- rv64imafdc-lp64d--"

          # --- X-HEEP CUSTOM SPLIT ---
          - name: xheep-base
            arch: rv32imc_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip
            abi: ilp32
            multilibs: "rv32im_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32-- rv32imc_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32--"

          - name: xheep-float
            arch: rv32imfc_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip
            abi: ilp32f
            multilibs: "rv32imf_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32f-- rv32imfc_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32f--"

          - name: xheep-zfinx
            arch: rv32imc_zfinx_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip
            abi: ilp32
            multilibs: "rv32im_zfinx_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32-- rv32imc_zfinx_xcvhwlp_xcvmem_xcvmac_xcvbi_xcvalu_xcvsimd_xcvbitmanip-ilp32--"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}
          max-size: 2G

      - name: Install base dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y \
            autoconf automake autotools-dev curl \
            gawk build-essential bison flex texinfo gperf libtool patchutils bc \
            zlib1g-dev libexpat-dev \
            git ca-certificates \
            qemu-user-static binfmt-support \
            "${{ matrix.host.gcc_pkg }}" "${{ matrix.host.gxx_pkg }}" "${{ matrix.host.binutils_pkg }}" \
            libgmp-dev libmpfr-dev libmpc-dev

      - name: Configure APT sources for multiarch
        shell: bash
        run: |
          set -euo pipefail

          if [[ -f /etc/apt/sources.list.d/ubuntu.sources ]]; then
            sudo cp -a /etc/apt/sources.list.d/ubuntu.sources /etc/apt/sources.list.d/ubuntu.sources.bak
            SIGNED_BY="$(awk -F': ' 'tolower($1)=="signed-by"{print $2; exit}' /etc/apt/sources.list.d/ubuntu.sources || true)"
            if [[ -z "${SIGNED_BY}" ]]; then
              SIGNED_BY="/usr/share/keyrings/ubuntu-archive-keyring.gpg"
            fi
            
            sudo tee /etc/apt/sources.list.d/ubuntu.sources >/dev/null <<EOF
          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu
          Suites: jammy jammy-updates jammy-backports
          Components: main restricted universe multiverse
          Architectures: amd64
          Signed-By: ${SIGNED_BY}

          Types: deb
          URIs: http://security.ubuntu.com/ubuntu
          Suites: jammy-security
          Components: main restricted universe multiverse
          Architectures: amd64
          Signed-By: ${SIGNED_BY}
          EOF
          else
            sudo cp -a /etc/apt/sources.list /etc/apt/sources.list.bak || true
            if [[ -f /etc/apt/sources.list ]]; then
              sudo sed -i -E 's/^deb(\s+)/deb [arch=amd64]\1/' /etc/apt/sources.list
            fi
          fi

          sudo dpkg --add-architecture "${{ matrix.host.foreign_arch }}"

          LIST="/etc/apt/sources.list.d/ubuntu-ports-${{ matrix.host.foreign_arch }}.list"
          sudo tee "${LIST}" >/dev/null <<EOF
          deb [arch=${{ matrix.host.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
          deb [arch=${{ matrix.host.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
          deb [arch=${{ matrix.host.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse
          deb [arch=${{ matrix.host.foreign_arch }}] http://ports.ubuntu.com/ubuntu-ports jammy-backports main restricted universe multiverse
          EOF

          sudo apt-get update -y --allow-releaseinfo-change

      - name: Install host (foreign-arch) dev libs
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get install -y \
            "libgmp-dev:${{ matrix.host.foreign_arch }}" \
            "libmpfr-dev:${{ matrix.host.foreign_arch }}" \
            "libmpc-dev:${{ matrix.host.foreign_arch }}" \
            "zlib1g-dev:${{ matrix.host.foreign_arch }}" \
            "libexpat1-dev:${{ matrix.host.foreign_arch }}"

      - name: Enable binfmt for QEMU
        shell: bash
        run: |
          set -euo pipefail
          sudo update-binfmts --enable "${{ matrix.host.qemu_binfmt }}" || true

      - name: Clone RISC-V Toolchain & Switch to OpenHW Core-V
        shell: bash
        run: |
          set -euo pipefail
          rm -rf riscv-gnu-toolchain
          
          git clone https://github.com/riscv-collab/riscv-gnu-toolchain.git
          cd riscv-gnu-toolchain
          git submodule update --init
          
          echo "Switching GCC to OpenHW CORE-V..."
          cd gcc
          git remote add corev https://github.com/openhwgroup/corev-gcc.git
          git fetch corev
          git checkout corev/development
          cd ..
          
          echo "Switching Binutils to OpenHW CORE-V..."
          cd binutils
          git remote add corev https://github.com/openhwgroup/corev-binutils-gdb.git
          git fetch corev
          git checkout corev/development
          cd ..

      - name: Prepare /opt Directory
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"
          sudo mkdir -p "${PREFIX}"
          sudo chown -R $USER:$USER /opt

      - name: Configure + Build
        shell: bash
        run: |
          set -euo pipefail
          cd riscv-gnu-toolchain

          # Usa ccache per i compilatori host
          export CC="ccache ${{ matrix.host.host_triplet }}-gcc"
          export CXX="ccache ${{ matrix.host.host_triplet }}-g++"
          export AR="${{ matrix.host.host_triplet }}-ar"
          export RANLIB="${{ matrix.host.host_triplet }}-ranlib"
          export CC_FOR_BUILD="ccache gcc"
          export CXX_FOR_BUILD="ccache g++"

          PREFIX="/opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"

          ./configure \
            --prefix="${PREFIX}" \
            --host="${{ matrix.host.host_triplet }}" \
            --build="x86_64-linux-gnu" \
            --with-sysroot="${PREFIX}/riscv-corev-elf" \
            --with-native-system-header-dir=/include \
            --with-newlib \
            --disable-shared \
            --enable-languages=c,c++ \
            --enable-tls \
            --disable-werror \
            --disable-libmudflap \
            --disable-libssp \
            --disable-quadmath \
            --disable-libgomp \
            --disable-nls \
            --disable-libbacktrace \
            --enable-multilib \
            --with-multilib-generator="${{ matrix.flavor.multilibs }}" \
            --with-arch=${{ matrix.flavor.arch }} \
            --with-abi=${{ matrix.flavor.abi }} \
            --with-bugurl='https://github.com/x-heep' \
            --with-pkgversion='corev-openhw-gcc-xheep-20240530-${{ matrix.flavor.name }}'

          # Make eseguito senza sudo (cartella /opt già di proprietà dell'utente)
          # Aggiunto -g0 per rimuovere i simboli di debug dalle librerie e velocizzare
          make -j"$(nproc)" \
            HOST="${{ matrix.host.host_triplet }}" \
            BUILD="x86_64-linux-gnu" \
            CFLAGS_FOR_TARGET="-Os -g0" \
            CXXFLAGS_FOR_TARGET="-Os -g0"

      - name: Verify toolchain host binary architecture
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"
          BIN="${PREFIX}/bin/riscv32-corev-elf-gcc"
          if [[ ! -x "$BIN" ]]; then
            BIN="${PREFIX}/bin/riscv64-corev-elf-gcc"
          fi
          if [[ ! -x "$BIN" ]]; then
            BIN="${PREFIX}/bin/riscv32-unknown-elf-gcc"
          fi
          if [[ ! -x "$BIN" ]]; then
            BIN="${PREFIX}/bin/riscv64-unknown-elf-gcc"
          fi
          test -x "$BIN" || { echo "ERROR: gcc not found at $BIN"; exit 1; }
          file "$BIN"
          file "$BIN" | grep -Eqi "${{ matrix.host.file_grep }}" || { echo "ERROR: host arch mismatch"; exit 1; }

      - name: Verify toolchain produces RISC-V ELF
        shell: bash
        run: |
          set -euo pipefail
          PREFIX="/opt/riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"
          export PATH="${PREFIX}/bin:${PATH}"

          cat > rvtest.c <<'EOF'
          int add(int a,int b){ return a+b; }
          EOF
          
          COMPILER=$(find "${PREFIX}/bin" -name "*-gcc" | head -n 1)
          
          "$COMPILER" -march=${{ matrix.flavor.arch }} -mabi=${{ matrix.flavor.abi }} -c -o rvtest.o rvtest.c
          
          file rvtest.o | grep -qiE "ELF (32|64)-bit" || { echo "ERROR: not a valid ELF"; exit 1; }
          readelf -h rvtest.o | grep -qi "Machine:.*RISC-V" || { echo "ERROR: not RISC-V"; exit 1; }

      - name: Create TAR Archive
        shell: bash
        run: |
          set -euo pipefail
          OUT="riscv-toolchain-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}.tar.gz"
          tar -czvf "$OUT" -C /opt "riscv-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: riscv-toolchain-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}
          path: riscv-toolchain-${{ matrix.host.arch_label }}-${{ matrix.flavor.name }}.tar.gz

  publish-rolling-release:
    needs: build-toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect tarballs
        shell: bash
        run: |
          set -euo pipefail
          find dist -type f -name "*.tar.gz" -print -exec cp -f {} . \;
          ls -la *.tar.gz

      - name: Publish rolling GitHub Release (latest)
        shell: bash
        run: |
          set -euo pipefail
          gh release delete latest --yes --cleanup-tag 2>/dev/null || true
          
          gh release create latest \
            *.tar.gz \
            --title "Latest RISC-V Toolchain (Split Matrix)" \
            --notes "Toolchains compilati separatamente per evitare il timeout di 6 ore. Run ${{ github.run_number }}, $(date -u +'%Y-%m-%d %H:%M UTC')."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
